amends "https://raw.githubusercontent.com/UIBK-DPS-DC/Cirrina-Specifications/main/pkl/CollaborativeStateMachineDescription.pkl"
import "https://raw.githubusercontent.com/UIBK-DPS-DC/Cirrina-Specifications/main/pkl/CollaborativeStateMachineDescription.pkl" as CSM
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/events.pkl" as Events
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/serviceTypes.pkl" as ServiceTypes
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/variables.pkl" as Vars
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/roomOccupancy/actions.pkl" as Actions
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/roomOccupancy/guards.pkl" as Guards
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/roomOccupancy/context.pkl" as Context

roomOccupancySM: CSM.StateMachineDescription = new {
    name = "roomOccupancy"
    localContext = Context.occupancyontext
    stateMachines {
        occupancyMonitor
    }
    states {
        rInit
        rVacant
        rOccupied
        rTransient        
    }
}

occupancyMonitor: CSM.StateMachineDescription = new {
    name = "OccupancyMonitoring"
    states {
        omInit
        omIdle
        omMonitoring
        omMaintenance
    }
}

rInit: CSM.StateDescription = new {
    name = "init"
    initial = true
    always {
        new {
            target = rVacant.name
        }
    }
}

rVacant: CSM.StateDescription = new {
    name = "vacant"
    entry {
        new CSM.AssignActionDescription{
            variable {
                name = Vars.vCurrentOccupancy
                value = "'vacant'"
                }
            }
    }
    after {
        new CSM.TimeoutActionDescription {
            name = "detectOccupancy"
            delay = "30000"
            action = Actions.aRaiseStartDetectingOccupancy
        }
    }
    on {
        new {
            event = Events.eStartDetectingOccupancy
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stDetectOccupancy
                    output {
                        new {
                            reference = Vars.vOccupancyDetected
                        }
                    }
                    done {
                        new {
                            name = Events.eDetectionComplete
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eDetectionComplete
            guards {
                new CSM.GuardDescription {
                    expression = Vars.vOccupancyDetected
                }
            }
            actions {
                Actions.aRaiseOccupancyDetected
            }
            target = rOccupied.name
        }
        new {
            event = Events.eDetectionComplete
            guards {
                new CSM.GuardDescription {
                    expression = "!\(Vars.vOccupancyDetected)"
                }
            }
            actions {
                Actions.aRaiseOccupancyVacant
            }
        }
    }
}

rOccupied: CSM.StateDescription = new {
    name = "occupied"
    entry {
        new CSM.AssignActionDescription{
            variable {
                name = Vars.vCurrentOccupancy
                value = "'occupied'"
                }
            }
    }
    after {
        new CSM.TimeoutActionDescription {
            name = "detectOccupancy"
            delay = "30000"
            action = Actions.aRaiseStartDetectingOccupancy
        }
    }
    on {
        new {
            event = Events.eStartDetectingOccupancy
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stDetectOccupancy
                    output {
                        new {
                            reference = Vars.vOccupancyDetected
                        }
                    }
                    done {
                        new {
                            name = Events.eDetectionComplete
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eDetectionComplete
            guards {
                new CSM.GuardDescription {
                    expression = Vars.vOccupancyDetected
                }
            }
            actions {
                Actions.aRaiseOccupancyDetected
            }
        }
        new {
            event = Events.eDetectionComplete
            guards {
                new CSM.GuardDescription {
                    expression = "!\(Vars.vOccupancyDetected)"
                }
            }
            actions {
                Actions.aRaiseOccupancyTransient
            }
            target = rTransient.name
        }
        new {
            event = Events.eActivateEnergySaving
            target = rTransient.name
            actions{
                new CSM.AssignActionDescription {
                    variable {
                        name = Vars.vEnergySaving
                        value = "true"
                    }
                }
                Actions.aRaiseOccupancyTransient
            }
        }
    }
}

rTransient: CSM.StateDescription = new {
    name = "transient"
    entry {
        new CSM.AssignActionDescription{
            variable {
                name = Vars.vCurrentOccupancy
                value = "'transient'"
                }
            }
    }
    after {
        new CSM.TimeoutActionDescription {
            name = "detectOccupancy"
            delay = "30000"
            action = Actions.aRaiseStartDetectingOccupancy
        }
    }
    on {
        new {
            event = Events.eStartDetectingOccupancy
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stDetectOccupancy
                    output {
                        new {
                            reference = Vars.vOccupancyDetected
                        }
                    }
                    done {
                        new {
                            name = Events.eDetectionComplete
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eDetectionComplete
            guards {
                new CSM.GuardDescription {
                    expression = Vars.vOccupancyDetected
                }
            }
            actions {
                Actions.aRaiseOccupancyDetected
            }
            target = rOccupied.name
        }
        new {
            event = Events.eDetectionComplete
            guards {
                new CSM.GuardDescription {
                    expression = "!\(Vars.vOccupancyDetected)"
                }
            }
            actions {
                Actions.aRaiseOccupancyVacant
            }
            target = rVacant.name
        }
    }
}