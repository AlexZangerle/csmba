import "https://raw.githubusercontent.com/CollaborativeStateMachines/Cirrina/develop/src/main/resources/pkl/CollaborativeStateMachineDescription.pkl" as CSM
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/events.pkl" as Events
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/serviceTypes.pkl" as ServiceTypes
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/variables.pkl" as Vars
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/energyManagement/guards.pkl" as Guards
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/energyManagement/context.pkl" as Context
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/energyManagement/actions.pkl" as Actions

// This module contains the definition for the energyManagement SM

//This SM contains the states for energyManagement
//It consists of four states
// Normal - Grid status is normal and energy cost below threshold
// Peak - Grid status is normal and energy cost above threshold
// GridRequestResponse - Grid status is demand responde
energyManagementSM = new CSM.StateMachineDescription {
    name = "energyManagement"
    localContext = Context.energyManagementContext
    states{
        emInit
        emNormal
        emPeak
        emGridRequestResponse
    }
}

local emInit: CSM.StateDescription = new {
    name = "init"
    initial = true
    always {
        new {
            target = emNormal.name
        }
    }
}
//Always start in normal mode
//Energy saving deactivated when entering this mode
local emNormal: CSM.StateDescription = new {
    name = "normal"
    entry{
        Actions.aRaiseDeactiveEnergySaving
        new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stGridNormal
                }
    }
    after{
        new CSM.TimeoutActionDescription {
            name = "energyCheck"
            delay = "30000"
            action = Actions.aRaiseStartDetectingEnergy
        }
    }
    on {
        //Invoke energy price server, upon completion invoke gridStatus service
        new {
            event = Events.eStartEnergyCheck
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stGetEnergyPrice
                    output {
                        new {
                            reference = Vars.vEnergyPrice
                        }
                    }
                    done {
                        new {
                            name = Events.eStartGridCheck
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eStartGridCheck
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stCheckGridStatus
                    output {
                        new {
                            reference = Vars.vGridStatus
                        }
                    }
                    done {
                        new {
                            name = Events.eEnergyCheckComplete
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eEnergyCheckComplete
            guards{
                Guards.gridDemandResponse
            }
            target = emGridRequestResponse.name
        }
        new {
            event = Events.eEnergyCheckComplete
            guards {
                Guards.priceAboveMax
                Guards.gridNormal
            }
            target = emPeak.name
        }
    }
}

// If current energy price is above threshold, throttle consumption
local emPeak: CSM.StateDescription = new {
    name = "peakDemand"
    entry {
        Actions.aRaiseEnergySaving
        new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stPeak
                }
    }
    after{
        new CSM.TimeoutActionDescription {
            name = "energyCheck"
            delay = "30000"
            action = Actions.aRaiseStartDetectingEnergy
        }
    }
    on {
        new {
            event = Events.eStartEnergyCheck
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stGetEnergyPrice
                    output {
                        new {
                            reference = Vars.vEnergyPrice
                        }
                    }
                    done {
                        new {
                            name = Events.eStartGridCheck
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eStartGridCheck
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stCheckGridStatus
                    output {
                        new {
                            reference = Vars.vGridStatus
                        }
                    }
                    done {
                        new {
                            name = Events.eEnergyCheckComplete
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eEnergyCheckComplete
            guards{
                Guards.gridDemandResponse
            }
            target = emGridRequestResponse.name
        }
        new {
            event = Events.eEnergyCheckComplete
            guards {
                Guards.priceUnderMax
                Guards.gridNormal
            }
            target = emNormal.name
        }
    }
}

// When demand response is received, throttle demand more aggressively
local emGridRequestResponse: CSM.StateDescription = new {
    name = "requestReponse"
    entry {
        Actions.aRaiseDrasticEnergySaving
        new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stGridResponse
                }
    }
    after{
        new CSM.TimeoutActionDescription {
            name = "energyCheck"
            delay = "30000"
            action = Actions.aRaiseStartDetectingEnergy
        }
    }
    on {
        new {
            event = Events.eStartEnergyCheck
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stGetEnergyPrice
                    output {
                        new {
                            reference = Vars.vEnergyPrice
                        }
                    }
                    done {
                        new {
                            name = Events.eStartGridCheck
                            channel = "internal"
                        }
                    }
                }
            }
        }
        new {
            event = Events.eStartGridCheck
            actions {
                new CSM.InvokeActionDescription {
                    serviceType = ServiceTypes.stCheckGridStatus
                    output {
                        new {
                            reference = Vars.vGridStatus
                        }
                    }
                    done {
                        new {
                            name = Events.eEnergyCheckComplete
                            channel = "internal"
                        }
                    }
                }
            }
        }     
        new {
            event = Events.eEnergyCheckComplete
            guards {
                Guards.gridNormal
                Guards.priceAboveMax
            }
            target = emPeak.name
        }
        new {
            event = Events.eEnergyCheckComplete
            guards{
                Guards.priceUnderMax
                Guards.gridNormal
            }
            target = emNormal.name
        }
    }
}