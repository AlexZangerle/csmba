import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/energyManagement/actions.pkl" as Actions
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/energyManagement/context.pkl" as Context
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/energyManagement/guards.pkl" as Guards
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/events.pkl" as Events
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/serviceTypes.pkl" as ServiceTypes
import "https://raw.githubusercontent.com/AlexZangerle/csmba/main/pkls/variables.pkl" as Vars
import "https://raw.githubusercontent.com/CollaborativeStateMachines/Cirrina/refs/heads/develop/src/main/resources/pkl/csm/Csml.pkl"

// This module contains the definition for the energyManagement SM

class energyManagementSM extends Csml.StateMachineDescription {
  name = "energyManagement"
  localContext = Context.energyManagementContext
  states {
    init
    normal
    fetchingGridStatus
    peak
    gridRequestResponse
  }
}

local const init: Csml.StateDescription = new {
  name = "init"
  initial = true
  always {
    new {
      target = normal.name
    }
  }
}

// Normal mode - Energy saving generally inactive unless triggered by price/grid.
local const normal: Csml.StateDescription = new {
  name = "normal"
  entry {
    Actions.aRaiseDeactiveEnergySaving
  }
  after {
    new Csml.TimeoutActionDescription {
      name = "energyCheck"
      delay = "30000"
      action = Actions.aRaiseStartDetectingEnergy
    }
  }
  on {
    new {
      event = Events.eStartEnergyCheck
      actions {
        new Csml.InvokeActionDescription {
          serviceType = ServiceTypes.stGetEnergyPrice
          output { new { reference = Vars.vEnergyPrice } }
          done { new { name = "priceCheckComplete"; channel = "internal" } }
        }
      }
    }
    new {
      event = "priceCheckComplete"
      target = fetchingGridStatus.name
    }
    new {
      event = Events.eEnterBusinessHours
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'businessHours'" } } }
    }
    new {
      event = Events.eEnterAfterHoursMode
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'afterHours'" } } }
    }
    new {
      event = Events.eEnterWeekend
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'weekendClosed'" } } }
    }
  }
}

// Intermediate State
local const fetchingGridStatus: Csml.StateDescription = new {
  name = "fetchingGridStatus"
  entry {
    new Csml.InvokeActionDescription {
      serviceType = ServiceTypes.stCheckGridStatus
      output { new { reference = Vars.vGridStatus } }
      done { new { name = Events.eEnergyCheckComplete; channel = "internal" } }
    }
  }
  on {
    new {
      event = Events.eEnergyCheckComplete
      guards {
        Guards.gridDemandResponse
        Guards.isBusinessHours
      }
      target = gridRequestResponse.name
    }
    new {
      event = Events.eEnergyCheckComplete
      guards {
        Guards.priceAboveMax
        Guards.gridNormal
        Guards.isBusinessHours
      }
      target = peak.name
    }
    new {
      event = Events.eEnergyCheckComplete
      guards {
        Guards.priceUnderMax
        Guards.gridNormal
        Guards.isBusinessHours
      }
      target = normal.name
    }
    new { event = Events.eFireAlarm; target = normal.name }
    new { event = Events.eGasLeakDetected; target = normal.name }
    new { event = Events.eSecurityBreachNotification; guards { Guards.isHighSeverityBreach }; target = normal.name }
  }
}


// Peak price mode - activate standard energy saving.
local const peak: Csml.StateDescription = new {
  name = "peakDemand"
  entry {
    Actions.aRaiseEnergySaving
  }
  after {
    new Csml.TimeoutActionDescription {
      name = "energyCheck"
      delay = "30000"
      action = Actions.aRaiseStartDetectingEnergy
    }
  }
  on {
    new {
      event = Events.eStartEnergyCheck
      actions {
        new Csml.InvokeActionDescription {
          serviceType = ServiceTypes.stGetEnergyPrice
          output { new { reference = Vars.vEnergyPrice } }
          done { new { name = "priceCheckComplete"; channel = "internal" } }
        }
      }
    }
    new {
      event = "priceCheckComplete"
      target = fetchingGridStatus.name
    }
    new {
      event = Events.eEnterBusinessHours
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'businessHours'" } } }
    }
    new {
      event = Events.eEnterAfterHoursMode
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'afterHours'" } } }
    }
    new {
      event = Events.eEnterWeekend
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'weekendClosed'" } } }
    }
    new { event = Events.eFireAlarm; target = normal.name }
    new { event = Events.eGasLeakDetected; target = normal.name }
    new { event = Events.eSecurityBreachNotification; guards { Guards.isHighSeverityBreach }; target = normal.name }
  }
}

// Grid demand response mode - activate drastic energy saving.
local const gridRequestResponse: Csml.StateDescription = new {
  name = "gridRequestResponse"
  entry {
    Actions.aRaiseDrasticEnergySaving
  }
  after {
    new Csml.TimeoutActionDescription {
      name = "energyCheck"
      delay = "30000"
      action = Actions.aRaiseStartDetectingEnergy
    }
  }
  on {
    new {
      event = Events.eStartEnergyCheck
      actions {
        new Csml.InvokeActionDescription {
          serviceType = ServiceTypes.stGetEnergyPrice
          output { new { reference = Vars.vEnergyPrice } }
          done { new { name = "priceCheckComplete"; channel = "internal" } }
        }
      }
    }
    new {
      event = "priceCheckComplete"
      target = fetchingGridStatus.name
    }
    new {
      event = Events.eEnterBusinessHours
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'businessHours'" } } }
    }
    new {
      event = Events.eEnterAfterHoursMode
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'afterHours'" } } }
    }
    new {
      event = Events.eEnterWeekend
      actions { new Csml.AssignActionDescription { variable { name = Vars.vCurrentSystemScheduleMode; value = "'weekendClosed'" } } }
    }
    new { event = Events.eFireAlarm; target = normal.name }
    new { event = Events.eGasLeakDetected; target = normal.name }
    new { event = Events.eSecurityBreachNotification; guards { Guards.isHighSeverityBreach }; target = normal.name }
  }
}
